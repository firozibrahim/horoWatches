!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CropperSelection=e()}(this,(function(){"use strict";const t="undefined"!=typeof window&&void 0!==window.document,e=t?window:{};t&&e.document.documentElement;const i="cropper",s=`${i}-canvas`,n=`${i}-image`,o=`${i}-selection`,a="select",h="scale",r="n-resize",c="e-resize",l="s-resize",d="w-resize",u="ne-resize",p="nw-resize",$="se-resize",m="sw-resize",v="keydown",f="action",b="actionend",g="actionstart",y="change",w=Number.isNaN||e.isNaN;function S(t){return"number"==typeof t&&!w(t)}function C(t){return S(t)&&t>0&&t<1/0}function k(t){return"object"==typeof t&&null!==t}const{hasOwnProperty:A}=Object.prototype;function E(t){if(!k(t))return!1;try{const{constructor:e}=t,{prototype:i}=e;return e&&i&&A.call(i,"isPrototypeOf")}catch(t){return!1}}const x=/([a-z\d])([A-Z])/g;function D(t){return String(t).replace(x,"$1-$2").toLowerCase()}const z=/-[A-z\d]/g;function N(t){return t.replace(z,(t=>t.slice(1).toUpperCase()))}const R=/\s\s*/;function O(t,e,i,s){e.trim().split(R).forEach((e=>{t.removeEventListener(e,i,s)}))}function T(t,e,i,s){e.trim().split(R).forEach((e=>{t.addEventListener(e,i,s)}))}const j={bubbles:!0,cancelable:!0,composed:!0};const M=Promise.resolve();function K(t){const{documentElement:i}=t.ownerDocument,s=t.getBoundingClientRect();return{left:s.left+(e.pageXOffset-i.clientLeft),top:s.top+(e.pageYOffset-i.clientTop)}}const L="contain";function P(t,e=L){const{aspectRatio:i}=t;let{width:s,height:n}=t;const o=C(s),a=C(n);if(o&&a){const t=n*i;e===L&&t>s||"cover"===e&&t<s?n=s/i:s=n*i}else o?n=s/i:a&&(s=n*i);return{width:s,height:n}}const W=/left|top|width|height/i,H="open",X=new WeakMap,Y=new WeakMap,B=new Map,q=e.document&&Array.isArray(e.document.adoptedStyleSheets)&&"replaceSync"in e.CSSStyleSheet.prototype;class U extends HTMLElement{get $sharedStyle(){return(this.themeColor?`:host{--theme-color: ${this.themeColor};}`:"")+":host([hidden]){display:none!important}"}constructor(){var t,e;super(),this.shadowRootMode=H,this.slottable=!0;const i=null===(e=null===(t=Object.getPrototypeOf(this))||void 0===t?void 0:t.constructor)||void 0===e?void 0:e.$name;i&&B.set(i,this.tagName.toLowerCase())}static get observedAttributes(){return["shadow-root-mode","slottable","theme-color"]}attributeChangedCallback(t,e,i){if(Object.is(i,e))return;const s=N(t);let n=i;switch(typeof this[s]){case"boolean":n=null!==i&&"false"!==i;break;case"number":n=Number(i)}switch(this[s]=n,t){case"theme-color":{const t=Y.get(this),e=this.$sharedStyle;t&&e&&(q?t.replaceSync(e):t.textContent=e);break}}}$propertyChangedCallback(t,e,i){if(!Object.is(i,e))switch(t=D(t),typeof i){case"boolean":!0===i?this.hasAttribute(t)||this.setAttribute(t,""):this.removeAttribute(t);break;case"number":i=w(i)?"":String(i);default:i?this.getAttribute(t)!==i&&this.setAttribute(t,i):this.removeAttribute(t)}}connectedCallback(){Object.getPrototypeOf(this).constructor.observedAttributes.forEach((t=>{const e=N(t);let i=this[e];(function(t){return void 0===t})(i)||this.$propertyChangedCallback(e,void 0,i),Object.defineProperty(this,e,{enumerable:!0,configurable:!0,get:()=>i,set(t){const s=i;i=t,this.$propertyChangedCallback(e,s,t)}})}));const t=this.attachShadow({mode:this.shadowRootMode||H});if(this.shadowRoot||X.set(this,t),Y.set(this,this.$addStyles(this.$sharedStyle)),this.$style&&this.$addStyles(this.$style),this.$template){const e=document.createElement("template");e.innerHTML=this.$template,t.appendChild(e.content)}if(this.slottable){const e=document.createElement("slot");t.appendChild(e)}}disconnectedCallback(){Y.has(this)&&Y.delete(this),X.has(this)&&X.delete(this)}$getTagNameOf(t){var e;return null!==(e=B.get(t))&&void 0!==e?e:t}$setStyles(t){return Object.keys(t).forEach((e=>{let i=t[e];S(i)&&(i=0!==i&&W.test(e)?`${i}px`:String(i)),this.style[e]=i})),this}$getShadowRoot(){return this.shadowRoot||X.get(this)}$addStyles(t){let e;const i=this.$getShadowRoot();return q?(e=new CSSStyleSheet,e.replaceSync(t),i.adoptedStyleSheets=i.adoptedStyleSheets.concat(e)):(e=document.createElement("style"),e.textContent=t,i.appendChild(e)),e}$emit(t,e,i){return function(t,e,i,s){return t.dispatchEvent(new CustomEvent(e,Object.assign(Object.assign(Object.assign({},j),{detail:i}),s)))}(this,t,e,i)}$nextTick(t){return function(t,e){return e?M.then(t?e.bind(t):e):M}(this,t)}static $define(i,s){k(i)&&(s=i,i=""),i||(i=this.$name||this.name),i=D(i),t&&e.customElements&&!e.customElements.get(i)&&customElements.define(i,this,s)}}U.$version="2.0.0-beta.4";const I=new WeakMap;class Z extends U{constructor(){super(...arguments),this.$onCanvasAction=null,this.$onCanvasActionStart=null,this.$onCanvasActionEnd=null,this.$onDocumentKeyDown=null,this.$action="",this.$actionStartTarget=null,this.$style=':host{display:block;left:0;position:relative;right:0}:host([outlined]){outline:1px solid var(--theme-color)}:host([multiple]){outline:1px dashed hsla(0,0%,100%,.5)}:host([multiple]):after{bottom:0;content:"";cursor:pointer;display:block;left:0;position:absolute;right:0;top:0}:host([multiple][active]){outline-color:var(--theme-color);z-index:1}:host([multiple])>*{visibility:hidden}:host([multiple][active])>*{visibility:visible}:host([multiple][active]):after{display:none}',this.x=0,this.y=0,this.width=0,this.height=0,this.aspectRatio=NaN,this.initialAspectRatio=NaN,this.initialCoverage=NaN,this.active=!1,this.movable=!1,this.resizable=!1,this.zoomable=!1,this.multiple=!1,this.keyboard=!1,this.outlined=!1,this.precise=!1}set $canvas(t){I.set(this,t)}get $canvas(){return I.get(this)}static get observedAttributes(){return super.observedAttributes.concat(["active","aspect-ratio","height","initial-aspect-ratio","initial-coverage","keyboard","movable","multiple","outlined","precise","resizable","width","x","y","zoomable"])}$propertyChangedCallback(t,e,i){if(!Object.is(i,e))switch(super.$propertyChangedCallback(t,e,i),t){case"aspectRatio":C(i)||(this.aspectRatio=NaN);break;case"initialAspectRatio":C(i)||(this.initialAspectRatio=NaN);break;case"initialCoverage":(!C(i)||i>1)&&(this.initialCoverage=NaN);break;case"keyboard":this.$nextTick((()=>{this.$canvas&&(i?this.$onDocumentKeyDown||(this.$onDocumentKeyDown=this.$handleKeyDown.bind(this),T(this.ownerDocument,v,this.$onDocumentKeyDown)):this.$onDocumentKeyDown&&(O(this.ownerDocument,v,this.$onDocumentKeyDown),this.$onDocumentKeyDown=null))}));break;case"multiple":this.$nextTick((()=>{if(this.$canvas){const t=this.$getSelections();i?(t.forEach((t=>{t.active=!1})),this.active=!0,this.$emit(y,{x:this.x,y:this.y,width:this.width,height:this.height})):(this.active=!1,t.slice(1).forEach((t=>{this.$removeSelection(t)})))}}))}}connectedCallback(){super.connectedCallback();const t=this.closest(this.$getTagNameOf(s));if(t){this.$canvas=t,this.$setStyles({position:"absolute",transform:`translate(${this.x}px, ${this.y}px)`}),this.hidden||this.$render();const{initialCoverage:e,parentElement:i}=this;if(C(e)&&i){const t=this.aspectRatio||this.initialAspectRatio,{offsetWidth:s,offsetHeight:n}=i;let o=s*e,a=n*e;C(t)&&({width:o,height:a}=P({aspectRatio:t,width:o,height:a})),this.$change(this.x,this.y,o,a),this.$center()}this.$onCanvasActionStart=this.$handleActionStart.bind(this),this.$onCanvasActionEnd=this.$handleActionEnd.bind(this),this.$onCanvasAction=this.$handleAction.bind(this),T(t,g,this.$onCanvasActionStart),T(t,b,this.$onCanvasActionStart),T(t,f,this.$onCanvasAction)}else this.$render()}disconnectedCallback(){const{$canvas:t}=this;t&&(this.$onCanvasActionStart&&(O(t,g,this.$onCanvasActionStart),this.$onCanvasActionStart=null),this.$onCanvasActionEnd&&(O(t,b,this.$onCanvasActionEnd),this.$onCanvasActionEnd=null),this.$onCanvasAction&&(O(t,f,this.$onCanvasAction),this.$onCanvasAction=null)),super.disconnectedCallback()}$getSelections(){let t=[];return this.parentElement&&(t=Array.from(this.parentElement.querySelectorAll(this.$getTagNameOf(o)))),t}$createSelection(){const t=this.cloneNode(!0);return this.hasAttribute("id")&&t.removeAttribute("id"),this.active=!1,this.parentElement&&this.parentElement.insertBefore(t,this.nextSibling),t}$removeSelection(t=this){if(this.parentElement){const e=this.$getSelections();if(e.length>1){const i=e.indexOf(t),s=e[i+1]||e[i-1];s&&(t.active=!1,this.parentElement.removeChild(t),s.active=!0,s.$emit(y,{x:s.x,y:s.y,width:s.width,height:s.height}))}else this.$reset(),this.hidden=!0}}$handleActionStart(t){var e,i;const s=null===(i=null===(e=t.detail)||void 0===e?void 0:e.relatedEvent)||void 0===i?void 0:i.target;this.$action="",this.$actionStartTarget=s,!this.hidden&&this.multiple&&!this.active&&s===this&&this.parentElement&&(this.$getSelections().forEach((t=>{t.active=!1})),this.active=!0,this.$emit(y,{x:this.x,y:this.y,width:this.width,height:this.height}))}$handleAction(t){const{currentTarget:e,detail:i}=t;if(e&&i){const{relatedEvent:s}=i;let{action:n}=i;if(!n&&this.multiple&&(n=this.$action||(null==s?void 0:s.target.action),this.$action=n),!n||this.hidden&&n!==a||this.multiple&&!this.active&&n!==h)return;const o=i.endX-i.startX,r=i.endY-i.startY,{width:c,height:l}=this;let{aspectRatio:d}=this;switch(!C(d)&&t.shiftKey&&(d=C(c)&&C(l)?c/l:1),n){case a:{const{$canvas:t}=this,s=K(e);(this.multiple&&!this.hidden?this.$createSelection():this).$change(i.startX-s.left,i.startY-s.top,o,r,d),n=$,o<0?r>0?n=m:r<0&&(n=p):o>0&&r<0&&(n=u),t&&(t.$action=n);break}case"move":this.movable&&this.$actionStartTarget&&this.contains(this.$actionStartTarget)&&this.$move(o,r);break;case h:if(s&&this.zoomable){const t=K(e);this.$zoom(i.scale,s.pageX-t.left,s.pageY-t.top)}break;default:this.$resize(n,o,r,d)}}}$handleActionEnd(){this.$action="",this.$actionStartTarget=null}$handleKeyDown(t){if(!(this.hidden||!this.keyboard||this.multiple&&!this.active||t.defaultPrevented))switch(t.key){case"Backspace":t.metaKey&&(t.preventDefault(),this.$removeSelection());break;case"Delete":t.preventDefault(),this.$removeSelection();break;case"ArrowLeft":t.preventDefault(),this.$move(-1,0);break;case"ArrowRight":t.preventDefault(),this.$move(1,0);break;case"ArrowUp":t.preventDefault(),this.$move(0,-1);break;case"ArrowDown":t.preventDefault(),this.$move(0,1);break;case"+":t.preventDefault(),this.$zoom(.1);break;case"-":t.preventDefault(),this.$zoom(-.1)}}$center(){const{parentElement:t}=this;if(!t)return this;const e=(t.offsetWidth-this.width)/2,i=(t.offsetHeight-this.height)/2;return this.$change(e,i)}$move(t,e=t){return this.$moveTo(this.x+t,this.y+e)}$moveTo(t,e=t){return this.movable?this.$change(t,e):this}$resize(t,e=0,i=0,s=this.aspectRatio){if(!this.resizable)return this;const n=C(s),{$canvas:o}=this;let{x:a,y:h,width:v,height:f}=this;switch(t){case r:h+=i,f-=i,f<0&&(t=l,f=-f,h-=f),n&&(a+=(e=i*s)/2,v-=e,v<0&&(v=-v,a-=v));break;case c:v+=e,v<0&&(t=d,v=-v,a-=v),n&&(h-=(i=e/s)/2,f+=i,f<0&&(f=-f,h-=f));break;case l:f+=i,f<0&&(t=r,f=-f,h-=f),n&&(a-=(e=i*s)/2,v+=e,v<0&&(v=-v,a-=v));break;case d:a+=e,v-=e,v<0&&(t=c,v=-v,a-=v),n&&(h+=(i=e/s)/2,f-=i,f<0&&(f=-f,h-=f));break;case u:n&&(i=-e/s),h+=i,f-=i,v+=e,v<0&&f<0?(t=m,v=-v,f=-f,a-=v,h-=f):v<0?(t=p,v=-v,a-=v):f<0&&(t=$,f=-f,h-=f);break;case p:n&&(i=e/s),a+=e,h+=i,v-=e,f-=i,v<0&&f<0?(t=$,v=-v,f=-f,a-=v,h-=f):v<0?(t=u,v=-v,a-=v):f<0&&(t=m,f=-f,h-=f);break;case $:n&&(i=e/s),v+=e,f+=i,v<0&&f<0?(t=p,v=-v,f=-f,a-=v,h-=f):v<0?(t=m,v=-v,a-=v):f<0&&(t=u,f=-f,h-=f);break;case m:n&&(i=-e/s),a+=e,v-=e,f+=i,v<0&&f<0?(t=u,v=-v,f=-f,a-=v,h-=f):v<0?(t=$,v=-v,a-=v):f<0&&(t=p,f=-f,h-=f)}return o&&o.$setAction(t),this.$change(a,h,v,f)}$zoom(t,e,i){if(!this.zoomable||0===t)return this;t<0?t=1/(1-t):t+=1;const{width:s,height:n}=this,o=s*t,a=n*t;let h=this.x,r=this.y;return S(e)&&S(i)?(h-=(o-s)*((e-this.x)/s),r-=(a-n)*((i-this.y)/n)):(h-=(o-s)/2,r-=(a-n)/2),this.$change(h,r,o,a)}$change(t,e,i=this.width,s=this.height,n=this.aspectRatio){return S(t)&&S(e)&&S(i)&&S(s)?(this.precise||(t=Math.round(t),e=Math.round(e),i=Math.round(i),s=Math.round(s)),t===this.x&&e===this.y&&i===this.width&&s===this.height?this:(this.hidden&&(this.hidden=!1),C(n)&&({width:i,height:s}=P({aspectRatio:n,width:i,height:s},"cover")),!1===this.$emit(y,{x:t,y:e,width:i,height:s})?this:(this.x=t,this.y=e,this.width=i,this.height=s,this.$render()))):this}$reset(){return this.$change(0,0,0,0)}$render(){return this.$setStyles({transform:`translate(${this.x}px, ${this.y}px)`,width:this.width,height:this.height})}$toCanvas(t){return new Promise(((e,i)=>{if(!this.isConnected)return void i(new Error("The current element is not connected to the DOM."));const s=document.createElement("canvas");let{width:o,height:a}=this,h=1;if(E(t)&&(C(t.width)||C(t.height))&&(({width:o,height:a}=P({aspectRatio:o/a,width:t.width,height:t.height})),h=o/this.width),s.width=o,s.height=a,!this.$canvas)return void e(s);const r=this.$canvas.querySelector(this.$getTagNameOf(n));r?r.$ready().then((i=>{const n=s.getContext("2d");if(n){const[e,c,l,d,u,p]=r.$getTransform(),$=-this.x,m=-this.y,v=($*d-l*m)/(e*d-l*c),f=(m-c*v)/d;let b=e*v+l*f+u,g=c*v+d*f+p,y=i.naturalWidth,w=i.naturalHeight;1!==h&&(b*=h,g*=h,y*=h,w*=h);const S=y/2,C=w/2;n.fillStyle="transparent",n.fillRect(0,0,o,a),E(t)&&"function"==typeof t.beforeDraw&&t.beforeDraw.call(this,n,s),n.save(),n.translate(S,C),n.transform(e,c,l,d,b,g),n.translate(-S,-C),n.drawImage(i,0,0,y,w),n.restore()}e(s)})).catch(i):e(s)}))}}return Z.$name=o,Z.$version="2.0.0-beta.4",Z}));
